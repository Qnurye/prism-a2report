# Prism A2Report - Technical Details

**Version:** 2.1
**Date:** 2026-02-06

---

## CJK Font Optimization

Chinese/Japanese/Korean fonts are extremely large (single files can exceed 10MB). To avoid loading the entire font file upfront, we use **unicode-range subsetting** — a technique that splits a font into dozens of small chunks, each covering a specific set of Unicode code points. The browser only downloads the chunks that contain characters actually present on the page.

### How It Works

1. **Build-time slicing**: During `astro build`, the Vite plugin `vite-plugin-font` invokes `cn-font-split` (a Rust-native tool) to:
   - Read the original `.ttf`/`.otf` font file
   - Split it into ~70-170 `.woff2` chunks (each covering a `unicode-range`)
   - Generate a `result.css` with `@font-face` declarations per chunk

2. **Generated CSS** (abbreviated):
   ```css
   /* Generated by cn-font-split */
   @font-face {
     font-family: "LXGW Neo XiHei";
     src: url("./a1b2c3d4.woff2") format("woff2");
     font-style: normal;
     font-weight: 400;
     font-display: swap;
     unicode-range: U+4E00-4E5F, U+4E8C-4EFF, ...;
   }
   @font-face {
     font-family: "LXGW Neo XiHei";
     src: url("./e5f6a7b8.woff2") format("woff2");
     font-display: swap;
     unicode-range: U+5000-506F, U+5080-50FF, ...;
   }
   /* ... 70+ more @font-face rules */
   ```

3. **Browser behavior**: When rendering text, the browser checks which `unicode-range` blocks match the characters on the page and only fetches those specific `.woff2` chunks. A typical Chinese-language page loads 5-15 chunks (~200-600KB) instead of the full 4-10MB font.

### Pipeline Integration

Instead of committing pre-sliced font files to Git (which would add hundreds of small files), we integrate slicing into the Vite build pipeline:

```javascript
// astro.config.mjs
import Font from 'vite-plugin-font';

export default defineConfig({
  vite: {
    plugins: [
      Font.vite({
        // Font sources are configured here
        // cn-font-split handles the actual slicing at build time
      })
    ],
  },
});
```

**What gets committed to Git**: Only the original `.ttf`/`.otf` source files (in `fonts/`).

**What gets generated at build time**: Sliced `.woff2` chunks + `result.css` (output to `dist/`).

### Font Sizes (Reference from qnury.es)

| Font             | Original Size | Sliced Chunks | Per-page Load (typical) |
| ---------------- | ------------- | ------------- | ----------------------- |
| LXGW Neo XiHei   | ~8MB          | ~78 chunks    | ~200-400KB              |
| GenRyuMin2 TC    | ~18MB         | ~170 chunks   | ~300-600KB              |
| Maple Mono CN    | ~4MB          | ~40 chunks    | ~100-200KB              |

---

## Content Negotiation

Cloudflare Pages Functions handle content negotiation at the edge.

### Middleware Implementation

```typescript
// functions/_middleware.ts
export async function onRequest(context) {
  const { request, next, env } = context;
  const url = new URL(request.url);

  // Only apply to report pages
  if (!url.pathname.startsWith('/reports/')) {
    return next();
  }

  const accept = request.headers.get('accept') || '';
  const ua = (request.headers.get('user-agent') || '').toLowerCase();

  const wantsMarkdown =
    accept.includes('text/markdown') ||
    accept.includes('text/plain') ||
    ua.includes('curl') ||
    ua.includes('wget') ||
    ua.includes('httpie') ||
    ua.includes('anthropic') ||
    ua.includes('openai') ||
    ua.includes('claudebot') ||
    ua.includes('gptbot');

  if (wantsMarkdown) {
    const mdPath = url.pathname.replace(/\/?$/, '/index.md');
    const mdResponse = await env.ASSETS.fetch(
      new URL(mdPath, url.origin)
    );

    if (mdResponse.ok) {
      return new Response(mdResponse.body, {
        headers: {
          'Content-Type': 'text/markdown; charset=utf-8',
          'X-Content-Format': 'markdown',
        },
      });
    }
  }

  return next();
}
```

### Example Behavior

```bash
# Browser (HTML)
curl -H "User-Agent: Mozilla/5.0" https://prism.qnury.es/reports/market-q1
# → 200 OK, Content-Type: text/html

# AI Agent (Markdown)
curl https://prism.qnury.es/reports/market-q1
# → 200 OK, Content-Type: text/markdown

# Explicit Markdown request
curl -H "Accept: text/markdown" https://prism.qnury.es/reports/market-q1
# → 200 OK, Content-Type: text/markdown
```

---

## llms.txt Content

```markdown
# Prism AI Report Archive

> AI-generated research reports deployed as interactive web documents.
> This site is managed by OpenClaw. Reports are published in both
> human-readable (HTML) and AI-readable (Markdown) formats.

## Capabilities

- Reports support content negotiation: use `Accept: text/markdown` or `curl` to receive Markdown
- An Agent Skill package is available for autonomous report management

## Skill

Download the full Agent Skill package:

- [Prism Report Manager Skill](/skill) — Instructions for downloading and using the skill
- [Skill Package (tar.gz)](/skill.tar.gz) — Downloadable skill archive

## Reports

- [All Reports](/reports/) — Index of all published reports
```

---

## Cloudflare Configuration

### Pages Project

```bash
# One-time setup
wrangler login
wrangler pages project create prism-a2report
```

### Custom Domain

```bash
wrangler pages domains add prism.qnury.es --project-name=prism-a2report
```

This requires a CNAME record in Cloudflare DNS:
```
CNAME  prism  prism-a2report.pages.dev
```

### Pages Functions

Content negotiation middleware is deployed automatically when `functions/_middleware.ts` exists in the project. No additional configuration needed — Cloudflare Pages Functions are included in the free tier (100,000 invocations/day).

---

## Key Scripts

### `deploy-report.sh`

```bash
#!/bin/bash
set -e

# Usage: ./scripts/deploy-report.sh <report.json> [slug]
REPORT_JSON="$1"
SLUG="${2:-"report-$(date +%Y%m%d-%H%M%S)"}"

if [ ! -f "$REPORT_JSON" ]; then
  echo "Error: File not found: $REPORT_JSON" >&2
  exit 1
fi

echo "Validating report..."
node scripts/validate-report.js "$REPORT_JSON"

echo "Generating MDX..."
node scripts/json-to-mdx.js "$REPORT_JSON" "$SLUG"

echo "Generating Markdown (AI-readable)..."
node scripts/json-to-markdown.js "$REPORT_JSON" "$SLUG"

echo "Packing skill tarball..."
tar -czf public/skill.tar.gz -C skill/ prism-report-manager/

echo "Building site..."
pnpm run build

echo "Deploying to Cloudflare Pages..."
OUTPUT=$(wrangler pages deploy dist --project-name=prism-a2report 2>&1)

URL="https://prism.qnury.es/reports/$SLUG"
echo ""
echo "Deployment complete."
echo "URL: $URL"
echo "Markdown: curl $URL"
```

### `list-reports.sh`

```bash
#!/bin/bash
# Lists all deployed report MDX files in the content directory
ls -1 src/content/reports/*.mdx 2>/dev/null | while read -r file; do
  slug=$(basename "$file" .mdx)
  title=$(head -5 "$file" | grep "^title:" | sed 's/title: *"\(.*\)"/\1/')
  date=$(head -5 "$file" | grep "^date:" | sed 's/date: *"\(.*\)"/\1/')
  echo "$date  $slug  $title"
done | sort -r
```

---

## Agent Skill Contents

### `/skill` Plaintext Guide

```text
# Prism Report Manager — Agent Skill

To use this skill, download and extract the skill package:

    curl -fsSL https://prism.qnury.es/skill.tar.gz | tar -xz

This creates a `prism-report-manager/` directory containing:

    prism-report-manager/
    ├── SKILL.md                       — Read this first
    ├── scripts/
    │   ├── deploy-report.sh           — Build and deploy a report
    │   ├── list-reports.sh            — List all deployed reports
    │   └── validate-report.js         — Validate report JSON against schema
    ├── references/
    │   ├── A2UI_FORMAT.md             — Report JSON format specification
    │   ├── REPORT_SCHEMA.json         — JSON Schema for report validation
    │   └── DEPLOYMENT_GUIDE.md        — Step-by-step deployment instructions
    └── assets/
        ├── example-simple-report.json — Minimal report example
        └── example-full-report.json   — Full-featured report example

After extracting, read SKILL.md for complete instructions.
```

### SKILL.md

```yaml
---
name: prism-report-manager
description: >
  Generate, deploy, and manage AI research reports on prism.qnury.es.
  Reports are deployed as static sites with both human-readable (HTML) and
  AI-readable (Markdown) formats. Use when conducting research that needs
  to be published, when reading existing reports, or when managing the
  report archive.
license: MIT
compatibility: >
  Requires local filesystem access to ~/Projects/prism-a2report,
  Node.js, pnpm, wrangler CLI, and internet access for deployment.
metadata:
  author: qnurye
  version: "1.0.0"
  site: https://prism.qnury.es
allowed-tools: Bash Read Write
---

# Prism Report Manager

Deploy AI-generated research reports as interactive web documents.

## When to use this skill

- You need to publish research findings as a web report
- You want to read or reference a previously deployed report
- You need to list, search, or manage existing reports

## Prerequisites

This skill operates on the local filesystem. Ensure:
- Working directory: `~/Projects/prism-a2report`
- Dependencies installed: `pnpm install`
- Wrangler authenticated: `wrangler login`

## Deploying a Report

### Step 1: Create Report JSON

Write a JSON file following the A2UI format. See `references/A2UI_FORMAT.md`
for the full specification, or `assets/example-simple-report.json` for a
minimal example.

### Step 2: Deploy

```bash
cd ~/Projects/prism-a2report
./scripts/deploy-report.sh /path/to/report.json [optional-slug]
```

The script will:
1. Validate the JSON against `references/REPORT_SCHEMA.json`
2. Convert JSON to MDX
3. Generate both HTML and Markdown outputs
4. Build the Astro site
5. Deploy to Cloudflare Pages
6. Print the public URL

### Step 3: Verify

```bash
# Human-readable
open https://prism.qnury.es/reports/<slug>

# AI-readable
curl https://prism.qnury.es/reports/<slug>
```

## Reading Reports

```bash
# List all deployed reports
./scripts/list-reports.sh

# Read a specific report (returns Markdown)
curl https://prism.qnury.es/reports/<slug>
```

## Report Format Reference

See `references/A2UI_FORMAT.md` for supported section types:
- `text` — Markdown content with optional heading
- `chart` — Chart.js chart (line, bar, pie, doughnut)
- `table` — Responsive data table
- `code` — Syntax-highlighted code block
- `callout` — Info/warning/success/error callout box
```

### Skill Tarball Generation

The tarball is regenerated as part of the build pipeline and placed in `dist/skill.tar.gz`:

```bash
tar -czf dist/skill.tar.gz -C skill/ prism-report-manager/
```
