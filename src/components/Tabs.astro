---
import { marked } from "marked";
import Chart from "./Chart.astro";
import Table from "./Table.astro";
import Callout from "./Callout.astro";
import CodeBlock from "./CodeBlock.astro";
import StatCard from "./StatCard.astro";
import Timeline from "./Timeline.astro";
import Figure from "./Figure.astro";
import Quote from "./Quote.astro";
import Accordion from "./Accordion.astro";

interface Section {
  type: string;
  [key: string]: any;
}

interface Props {
  tabs: Array<{ label: string; sections: Section[] }>;
  defaultTab?: number;
}

const { tabs, defaultTab = 0 } = Astro.props;
const tabsId = `tabs-${Math.random().toString(36).slice(2, 9)}`;
---

<div class="my-6" id={tabsId} data-tabs-id={tabsId}>
  <div class="border-b border-border" role="tablist">
    {
      tabs.map((tab, index) => (
        <button
          role="tab"
          aria-selected={index === defaultTab ? "true" : "false"}
          aria-controls={`${tabsId}-panel-${index}`}
          data-tab-index={index}
          class:list={[
            "px-4 py-2 font-ui text-sm transition-colors -mb-px",
            index === defaultTab
              ? "border-b-2 border-primary text-foreground font-medium"
              : "text-muted-foreground hover:text-foreground",
          ]}
        >
          {tab.label}
        </button>
      ))
    }
  </div>
  {
    tabs.map((tab, index) => (
      <div
        id={`${tabsId}-panel-${index}`}
        role="tabpanel"
        data-tab-panel={index}
        class:list={["p-4 text-sm leading-relaxed", index !== defaultTab && "hidden"]}
        style={index === defaultTab ? "opacity: 1" : "opacity: 0"}
      >
        {tab.sections.map((section) => (
          <>
            {section.type === "text" && (
              <div class="prose">
                {section.heading && (
                  <Fragment
                    set:html={`<h${section.level || 2}>${section.heading}</h${section.level || 2}>`}
                  />
                )}
                <Fragment set:html={marked.parse(section.content)} />
              </div>
            )}
            {section.type === "chart" && (
              <Chart chartType={section.chartType} data={section.data} options={section.options} />
            )}
            {section.type === "table" && (
              <Table headers={section.headers} rows={section.rows} caption={section.caption} />
            )}
            {section.type === "code" && (
              <CodeBlock
                language={section.language}
                filename={section.filename}
                code={section.code}
              />
            )}
            {section.type === "callout" && (
              <Callout variant={section.variant} title={section.title}>
                {section.content}
              </Callout>
            )}
            {section.type === "statcard" && (
              <StatCard
                label={section.label}
                value={section.value}
                description={section.description}
                trend={section.trend}
                trendValue={section.trendValue}
              />
            )}
            {section.type === "timeline" && <Timeline events={section.events} />}
            {section.type === "figure" && (
              <Figure
                src={section.src}
                alt={section.alt}
                caption={section.caption}
                width={section.width}
              />
            )}
            {section.type === "quote" && (
              <Quote text={section.text} author={section.author} role={section.role} />
            )}
            {section.type === "accordion" && (
              <Accordion items={section.items} allowMultiple={section.allowMultiple} />
            )}
          </>
        ))}
      </div>
    ))
  }
</div>

<script>
  function initTabs() {
    document.querySelectorAll<HTMLElement>("[data-tabs-id]").forEach((container) => {
      const buttons = container.querySelectorAll<HTMLButtonElement>("[role='tab']");
      const panels = container.querySelectorAll<HTMLElement>("[role='tabpanel']");

      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const index = btn.dataset.tabIndex!;

          buttons.forEach((b) => {
            const isActive = b.dataset.tabIndex === index;
            b.setAttribute("aria-selected", String(isActive));
            b.className = isActive
              ? "px-4 py-2 font-ui text-sm transition-colors -mb-px border-b-2 border-primary text-foreground font-medium"
              : "px-4 py-2 font-ui text-sm transition-colors -mb-px text-muted-foreground hover:text-foreground";
          });

          panels.forEach((panel) => {
            const isActive = panel.dataset.tabPanel === index;
            if (isActive) {
              panel.classList.remove("hidden");
              panel.style.opacity = "0";
              requestAnimationFrame(() => {
                panel.style.transition = "opacity 150ms ease";
                panel.style.opacity = "1";
              });
            } else {
              panel.classList.add("hidden");
              panel.style.opacity = "0";
            }
          });
        });
      });
    });
  }

  initTabs();
</script>
